.cloud-deploy: &cloud-deploy
  image: registry.gitlab.com/ebaque/cloud-deploy:latest
 
.docker: &docker
  image: docker:19.03-git
  services:
    - docker:19.03-dind
  variables:
    DOCKER_DRIVER: overlay2
 
build app image:
  <<: *docker
  stage: build
  script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - docker build -t "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA" .
    - docker push "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA"
  only:
    refs:
      - branches
 
deploy app to ECS:
  <<: *cloud-deploy
  stage: review
  script:
    - ecs update-task-definition
  only:
    refs:
      - branches
